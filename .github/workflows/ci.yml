name: CI/CD CodeHealth Java

on:
  push:
    branches:
      - develop

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    # Extra da atividade: usar um secret (opcional)
    env:
      DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # CI ‚Äì Build
      - name: Etapa de Build (javac simulado)
        run: |
          echo "üîß Compilando App.java..."
          javac App.java
          echo "‚úÖ Compila√ß√£o conclu√≠da."

      # CI ‚Äì Testes (simulados rodando a classe App)
      - name: Etapa de Testes (simulada)
        run: |
          echo "üß™ Executando testes simulados..."
          java App
          echo "‚úÖ Execu√ß√£o de testes simulados finalizada."

      # Relat√≥rio quando tudo deu certo
      - name: Relat√≥rio - Sucesso
        if: success()
        run: |
          echo "‚úÖ Build e testes bem-sucedidos. Pipeline ok."

      # Relat√≥rio quando deu erro
      - name: Relat√≥rio - Falha
        if: failure()
        run: |
          echo "‚ùå Testes falharam ou build quebrou. Corrija o c√≥digo antes de tentar de novo."

      # CD ‚Äì Deploy simulado (s√≥ roda se deu sucesso)
      - name: Deploy para Homologa√ß√£o (simulado)
        if: success()
        run: |
          echo "üöÄ Realizando deploy simulado para ambiente de homologa√ß√£o..."
          mkdir -p staging
          zip -r staging/codehealth-artifact.zip App.java README.md
          echo "Deploy simulado conclu√≠do. Artefato gerado em staging/codehealth-artifact.zip"

      # Extra: mostrar uso do DEPLOY_KEY (sem revelar)
      - name: Mostrar uso do DEPLOY_KEY (simulado)
        if: success()
        run: |
          echo "Usando DEPLOY_KEY armazenada em GitHub Secrets (valor n√£o exibido por seguran√ßa)."
